<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title
	th:text="${listTitle != null ? listTitle : 'Game Sessions'} + ' - Reiunio'">Game
	Sessions - Reiunio</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="/css/styles.css">
</head>
<body>
	<div th:replace="~{fragments/navbar :: navbar}"></div>

	<div class="container my-4">
		<!-- Messages -->
		<div th:if="${message}"
			class="alert alert-success alert-dismissible fade show" role="alert">
			<span th:text="${message}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>

		<div th:if="${error}"
			class="alert alert-danger alert-dismissible fade show" role="alert">
			<span th:text="${error}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"
				aria-label="Close"></button>
		</div>

		<!-- Header -->
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h1 th:text="${listTitle != null ? listTitle : 'Game Sessions'}">Game
				Sessions</h1>
			<div>
				<a href="/game-sessions/new" class="btn btn-primary"> <i
					class="bi bi-plus-circle"></i> New Session
				</a>
			</div>
		</div>

		<!-- Filter System -->
		<div class="card mb-4">
			<div class="card-body">
				<div class="row text-center">
					<div class="col-lg col-md-4 col-6 mb-2">
						<a href="/game-sessions" class="btn w-100"
							th:classappend="${param.filter == null or param.filter[0] == 'all'} ? 'btn-primary' : 'btn-outline-primary'">
							<i class="bi bi-calendar-event"></i><br> <span>All</span>
						</a>
					</div>
					<div class="col-lg col-md-4 col-6 mb-2">
						<a href="/game-sessions?filter=today" class="btn w-100"
							th:classappend="${param.filter != null and param.filter[0] == 'today'} ? 'btn-primary' : 'btn-outline-primary'">
							<i class="bi bi-calendar-today"></i><br> <span>Today</span>
						</a>
					</div>
					<div class="col-lg col-md-4 col-6 mb-2">
						<a href="/game-sessions?filter=upcoming" class="btn w-100"
							th:classappend="${param.filter != null and param.filter[0] == 'upcoming'} ? 'btn-success' : 'btn-outline-success'">
							<i class="bi bi-calendar-plus"></i><br> <span>Upcoming</span>
						</a>
					</div>
					<div class="col-lg col-md-4 col-6 mb-2">
						<a href="/game-sessions?filter=registered" class="btn w-100"
							th:classappend="${param.filter != null and param.filter[0] == 'registered'} ? 'btn-info' : 'btn-outline-info'">
							<i class="bi bi-person-check"></i><br> <span>Registered</span>
						</a>
					</div>
					<div class="col-lg col-md-4 col-6 mb-2">
						<a href="/game-sessions?filter=finished" class="btn w-100"
							th:classappend="${param.filter != null and param.filter[0] == 'finished'} ? 'btn-secondary' : 'btn-outline-secondary'">
							<i class="bi bi-check-circle"></i><br> <span>Finished</span>
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Sessions Grouped by Days -->
		<div th:if="${sessionsByDay != null and !sessionsByDay.empty}">
			<div th:each="dayEntry, dayEntryStat : ${sessionsByDay}" class="mb-5">
				<!-- Day Header -->
				<div class="day-header">
					<div class="d-flex justify-content-between align-items-center">
						<h3 class="text-primary mb-0">
							<i class="bi bi-calendar-day"></i> <span
								th:text="${#temporals.format(dayEntry.key, 'EEEE, dd MMMM yyyy')}">Monday,
								01 January 2025</span>
						</h3>
						<span class="badge bg-primary"> <span
							th:text="${dayEntry.value.size()}">3</span> session<span
							th:if="${dayEntry.value.size() > 1}">s</span>
						</span>
					</div>
				</div>

				<!-- Sessions for this day in rows of 3 -->
				<div class="sessions-for-day">
					<div class="row">
						<!-- OPTIMIZADO: Un solo bucle para todas las sesiones del día -->
						<div th:each="gameSession : ${dayEntry.value}"
							class="col-lg-4 col-md-6 mb-3">
							<div class="session-card">
								<div class="card h-100 shadow-sm">
									<div
										class="card-header d-flex justify-content-between align-items-center">
										<h5 class="card-title mb-0" th:text="${gameSession.title}">Session Title</h5>
										
										<span class="badge" th:text="${gameSession.status}"
											th:classappend="${gameSession.status.name() == 'SCHEDULED' ? 'bg-light text-dark' : 
                                                              gameSession.status.name() == 'IN_PROGRESS' ? 'bg-warning text-dark' : 
                                                              gameSession.status.name() == 'FINISHED' ? 'bg-success' : 'bg-danger'}">
										</span>
										
									</div>

									<div class="card-body">
										<div class="row">
											<!-- Información del juego y sesión (lado izquierdo) -->
											<div class="col-9">
												<h6 class="card-subtitle mb-2 text-muted">
													<i class="bi bi-joystick"></i> <span
														th:if="${gameSession.isLibraryGame()}"> <a
														th:href="@{/games/{id}(id=${gameSession.game.id})}"
														th:text="${gameSession.customGameName}"
														class="text-decoration-none">Game Name</a> <i
														class="bi bi-bookmark-fill text-primary ms-1"
														title="Library Game"></i>
													</span> <span th:unless="${gameSession.isLibraryGame()}"> <span
														th:text="${gameSession.customGameName}">Game Name</span> <i
														class="bi bi-person-check-fill text-success ms-1"
														title="Personal Game"></i>

													</span>
												</h6>

												<!-- Session time -->
												<div th:if="${!gameSession.isMultiDay()}">
													<p class="card-text session-time">
														<i class="bi bi-clock"></i> <span
															th:text="${#temporals.format(gameSession.startTime, 'HH:mm')}">10:00</span>
														<span th:if="${gameSession.endTime}"> - <span
															th:text="${#temporals.format(gameSession.endTime, 'HH:mm')}">12:00</span>
														</span>
													</p>
												</div>

												<div th:if="${gameSession.isMultiDay()}">
													<p class="card-text">
														<i class="bi bi-calendar-range text-warning"></i> <small
															class="badge bg-warning text-dark">Multi-day
															event</small>
													</p>
													<p class="card-text small">
														<strong>Ends:</strong> <span
															th:text="${#temporals.format(gameSession.endDate, 'dd/MM/yyyy')}">05/01</span>
														<span th:if="${gameSession.endTime}"> at <span
															th:text="${#temporals.format(gameSession.endTime, 'HH:mm')}">18:00</span>
														</span>
													</p>
												</div>

												<p class="card-text">
													<i class="bi bi-people"></i> <span
														th:text="${gameSession.players.size()}">2</span> / <span
														th:text="${gameSession.maxPlayers}">4</span> players
												</p>
												<div
													class="creator-info card-text d-flex align-items-center">

													<!-- Imagen personalizada si existe -->
													<img th:if="${gameSession.creator.hasCustomProfilePhoto()}"
														th:src="${gameSession.creator.profilePhotoPath}"
														th:alt="'Profile photo of ' + ${gameSession.creator.firstName}"
														class="rounded-circle creator-avatar me-2"
														style="width: 32px; height: 32px; object-fit: cover; border: 1px solid #ccc;"
														onerror="this.src='/defaults/user-placeholder.jpg';">

													<!-- Imagen por defecto si no hay personalizada -->
													<img
														th:unless="${gameSession.creator.hasCustomProfilePhoto()}"
														src="/defaults/user-placeholder.jpg"
														th:alt="'Default photo for ' + ${gameSession.creator.firstName}"
														class="rounded-circle creator-avatar me-2"
														style="width: 32px; height: 32px; object-fit: cover; border: 1px solid #ccc;">

													<small class="text-muted"> <span
														th:text="${gameSession.creator.firstName + ' ' + gameSession.creator.lastName}">Reiunio</span>
													</small>
												</div>
											</div>

											<!-- Imagen del juego (lado derecho) -->
											<div
												class="col-3 text-center d-flex align-items-center justify-content-center">
												<!-- Library game image -->
												<div th:if="${gameSession.isLibraryGame()}">
													<a th:href="@{/games/{id}(id=${gameSession.game.id})}">
														<img th:src="${gameSession.game.getImageUrl()}"
														th:alt="'Photo of ' + ${gameSession.game.name}"
														class="rounded img-fluid shadow-sm"
														style="height: 70px; width: 70px; object-fit: cover; border: 2px solid #0d6efd;"
														onerror="this.src='/defaults/game-placeholder.jpg';">
													</a>
												</div>

												<!-- Personal game image -->
												<div th:unless="${gameSession.isLibraryGame()}">
													<!-- Show custom image if available -->
													<img th:if="${gameSession.hasCustomGameImage()}"
														th:src="${gameSession.customGameImagePath}"
														th:alt="'Custom image for ' + ${gameSession.customGameName}"
														class="rounded img-fluid shadow-sm"
														style="height: 70px; width: 70px; object-fit: cover; border: 2px solid #198754;"
														onerror="this.src='/defaults/game-placeholder.jpg';">

													<!-- Show placeholder if no custom image -->
													<img th:unless="${gameSession.hasCustomGameImage()}"
														src="/defaults/game-placeholder.jpg"
														th:alt="'Image for personal game: ' + ${gameSession.customGameName}"
														class="rounded img-fluid shadow-sm"
														style="height: 70px; width: 70px; object-fit: cover; border: 2px solid #198754;">
												</div>
											</div>
										</div>
									</div>

									<div class="card-footer bg-transparent">
										<div class="d-flex justify-content-between align-items-center">
											<div class="d-flex align-items-center">
												<a th:href="@{/game-sessions/{id}(id=${gameSession.id})}"
													class="btn btn-primary btn-sm"> <i class="bi bi-eye"></i>
													View
												</a>

												<!-- Edit and Delete buttons for authorized users -->
												<div
													th:with="currentUserName=${#authentication.principal.username}"
													sec:authorize="isAuthenticated()">
													<!-- Admin can edit any session -->
													<div sec:authorize="hasRole('ADMIN')">
														<a
															th:href="@{/game-sessions/{id}/edit(id=${gameSession.id})}"
															class="btn btn-warning btn-sm ms-1"> <i
															class="bi bi-pencil"></i>
														</a>
														<button type="button"
															class="btn btn-danger btn-sm ms-1 delete-session-btn"
															th:data-session-id="${gameSession.id}"
															th:data-session-title="${gameSession.title}"
															th:data-is-library-game="${gameSession.isLibraryGame()}"
															th:data-game-name="${gameSession.isLibraryGame() ? gameSession.game.name : ''}">
															<i class="bi bi-trash"></i>
														</button>
													</div>

													<!-- Creator can edit their own session (if not admin) -->
													<div sec:authorize="!hasRole('ADMIN')"
														th:if="${currentUserName != null and currentUserName == gameSession.creator.username}">
														<a
															th:href="@{/game-sessions/{id}/edit(id=${gameSession.id})}"
															class="btn btn-warning btn-sm ms-1"> <i
															class="bi bi-pencil"></i>
														</a>
														<button type="button"
															class="btn btn-danger btn-sm ms-1 delete-session-btn"
															th:data-session-id="${gameSession.id}"
															th:data-session-title="${gameSession.title}"
															th:data-is-library-game="${gameSession.isLibraryGame()}"
															th:data-game-name="${gameSession.isLibraryGame() ? gameSession.game.name : ''}">
															<i class="bi bi-trash"></i>
														</button>
													</div>
												</div>
											</div>

											<!-- User registration indicator -->
											<div sec:authorize="isAuthenticated()">
												<div
													th:with="currentUserName=${#authentication.principal.username}">
													<div th:each="player : ${gameSession.players}">
														<span
															th:if="${player.user != null and player.user.username == currentUserName}"
															class="badge bg-success"> <i
															class="bi bi-check-circle-fill"></i> Registered
														</span>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Separator between days (except for the last day) -->
				<div th:unless="${dayEntryStat.last}" class="day-separator"></div>
			</div>
		</div>

		<!-- Empty state -->
		<div
			th:if="${(sessionsByDay == null or sessionsByDay.empty) and (gameSessions == null or gameSessions.empty)}">
			<div class="text-center py-5">
				<i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
				<h3 class="mt-3 text-muted">No game sessions found</h3>
				<p class="text-muted">No sessions match your current filter
					criteria.</p>
				<a href="/game-sessions/new" class="btn btn-primary"> <i
					class="bi bi-plus-circle"></i> Create Your First Session
				</a>
			</div>
		</div>
	</div>

	<!-- Delete Confirmation Modal -->
	<div class="modal fade" id="deleteSessionModal" tabindex="-1"
		aria-labelledby="deleteSessionModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white">
					<h5 class="modal-title" id="deleteSessionModalLabel">Confirm
						deletion</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>
						Are you sure you want to delete the session <strong
							id="sessionTitleToDelete"></strong>?
					</p>
					<p class="text-danger">This action cannot be undone and all
						player registrations will be lost.</p>
					<div id="libraryGameInfo" class="alert alert-info"
						style="display: none;">
						<i class="bi bi-info-circle"></i> The library game "<span
							id="gameNameToRelease"></span>" will become available for loans
						again.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Cancel</button>
					<form id="deleteSessionForm" method="post">
						<button type="submit" class="btn btn-danger">Delete</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<footer class="bg-dark text-white py-4 mt-4">
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<h5>Reiunio</h5>
					<p>Application for managing game libraries and board games.</p>
				</div>
				<div class="col-md-6 text-md-end">
					<p>&copy; 2025 Reiunio. All rights reserved.</p>
				</div>
			</div>
		</div>
	</footer>

	<!-- Scripts -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="/js/scripts.js"></script>

	<!-- Modal handling script -->
	<script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle delete modal for sessions
            const deleteModal = document.getElementById('deleteSessionModal');
            const deleteForm = document.getElementById('deleteSessionForm');
            const sessionTitleSpan = document.getElementById('sessionTitleToDelete');
            const libraryGameInfo = document.getElementById('libraryGameInfo');
            const gameNameSpan = document.getElementById('gameNameToRelease');
            const deleteButtons = document.querySelectorAll('.delete-session-btn');
            
            // Event handling for delete buttons
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const sessionId = this.getAttribute('data-session-id');
                    const sessionTitle = this.getAttribute('data-session-title');
                    const isLibraryGame = this.getAttribute('data-is-library-game') === 'true';
                    const gameName = this.getAttribute('data-game-name');
                    
                    // Update modal content
                    sessionTitleSpan.textContent = sessionTitle;
                    deleteForm.action = '/game-sessions/' + sessionId + '/delete';
                    
                    // Show/hide library game info
                    if (isLibraryGame && gameName) {
                        gameNameSpan.textContent = gameName;
                        libraryGameInfo.style.display = 'block';
                    } else {
                        libraryGameInfo.style.display = 'none';
                    }
                    
                    // Show modal
                    const modalInstance = new bootstrap.Modal(deleteModal);
                    modalInstance.show();
                });
            });
        });
    </script>
</body>
</html>